# Setup script to redirect Vivado outputs to build directory
# This script creates symbolic links from project directory to build directory
# Note: Uses exec to create symlinks for better cross-platform compatibility

set project_dir "@VIVADO_PROJECT_DIR@"
set project_name "@VIVADO_PROJECT_NAME@"
set build_dir "@VIVADO_BUILD_DIR@"

# Create build directory structure
file mkdir "$build_dir/cache"
file mkdir "$build_dir/gen"
file mkdir "$build_dir/runs"
file mkdir "$build_dir/hw"
file mkdir "$build_dir/sim"
file mkdir "$build_dir/ip_user_files"

# Remove existing directories/symlinks if they exist
set dirs_to_link [list \
    "$project_dir/${project_name}.cache" \
    "$project_dir/${project_name}.gen" \
    "$project_dir/${project_name}.runs" \
    "$project_dir/${project_name}.hw" \
    "$project_dir/${project_name}.sim" \
    "$project_dir/${project_name}.ip_user_files" \
]

foreach dir $dirs_to_link {
    if {[file exists $dir]} {
        # Check if it's a symlink
        if {[catch {file type $dir} type] == 0} {
            if {$type == "link"} {
                # Remove existing symlink
                file delete $dir
                puts "Removed existing symlink: $dir"
            } else {
                # It's a real directory - move it to build directory first
                set dir_name [file tail $dir]
                set target "$build_dir/$dir_name"
                if {![file exists $target]} {
                    # Use exec to move (more reliable for large directories)
                    catch {exec mv "$dir" "$target"}
                    puts "Moved existing directory $dir to $target"
                } else {
                    # Target exists, just remove the source
                    catch {exec rm -rf "$dir"}
                    puts "Removed existing directory: $dir"
                }
            }
        }
    }
}

# Create symbolic links from project directory to build directory using exec
set link_pairs [list \
    [list "$project_dir/${project_name}.cache" "$build_dir/cache"] \
    [list "$project_dir/${project_name}.gen" "$build_dir/gen"] \
    [list "$project_dir/${project_name}.runs" "$build_dir/runs"] \
    [list "$project_dir/${project_name}.hw" "$build_dir/hw"] \
    [list "$project_dir/${project_name}.sim" "$build_dir/sim"] \
    [list "$project_dir/${project_name}.ip_user_files" "$build_dir/ip_user_files"] \
]

foreach pair $link_pairs {
    set link_path [lindex $pair 0]
    set target_path [lindex $pair 1]
    
    if {![file exists $link_path]} {
        # Use exec ln -s for more reliable symlink creation
        catch {exec ln -s "$target_path" "$link_path"}
        if {[file exists $link_path]} {
            puts "Created symlink: $link_path -> $target_path"
        } else {
            puts "WARNING: Failed to create symlink: $link_path"
        }
    } else {
        puts "Path already exists (skipping): $link_path"
    }
}

puts "Vivado output directories redirected to: $build_dir"

